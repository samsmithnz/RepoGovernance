@using RepoAutomation.Core.Models
@using RepoGovernance.Core.Models
@using System.Text.Json;
@model SummaryItemsIndex
@{
    ViewData["Title"] = "Home Page";

    TimeSpan ts = new();
    string lastUpdated = "[unknown]";
    string user = "[unknown]";
    if (Model.SummaryItems.Count > 0)
    {
        DateTime minDate = DateTime.Now;
        DateTime maxDate = DateTime.Now;
        @foreach (SummaryItem item in Model.SummaryItems)
        {
            if (minDate > item.LastUpdated)
            {
                minDate = item.LastUpdated;
            }
            if (maxDate < item.LastUpdated)
            {
                maxDate = item.LastUpdated;
            }
        }
        ts = maxDate - minDate;
        lastUpdated = maxDate.ToString("dd-MMM-yyyy h:mm:sstt");
        user = Model.SummaryItems[0].User;
    }
}

<div>
    <div class="row">
        <div class="col-md-6">
            <h4>For user <code>@user</code>@* (last updated at @lastUpdated)*@</h4>
            <b>Legend</b>: <i class="bi bi-heart-fill greenHeart" data-toggle="tooltip" data-placement="bottom" title="No recommendations"></i>=Repo is OK, no recommendations
            <i class="bi bi-heart-pulse redHeart" data-toggle="tooltip" data-placement="bottom" title="Recommendations for improvement"></i>=Recommendations for improvement
        </div>
        <div class="col-md-6">
            <h4>&nbsp;</h4>
            <div style="font-size:14px;">
                <strong>Top 5 languages detected:</strong><br />
                @if (Model.SummaryRepoLanguages != null && Model.SummaryRepoLanguages.Count > 0)
                {
                    for (int i = 0; (Model.SummaryRepoLanguages.Count < 5 && i < Model.SummaryRepoLanguages.Count) || i < 5; i++)
                    {
                        RepoLanguage item = Model.SummaryRepoLanguages[i];
                        <span class="box" style="background-color: @item.Color;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <span>@item.Name: @item.Percent.ToString("0.0")%</span>
                    }
                }
            </div>
            <br />
        </div>
    </div>
    <div>
        @foreach (SummaryItem item in Model.SummaryItems)
        {
            string visibility = item.RepoSettings.visibility switch
            {
                null => throw new ArgumentNullException(nameof(item.RepoSettings.visibility)),
                "" => throw new ArgumentException($"{nameof(item.RepoSettings.visibility)} cannot be empty", nameof(item.RepoSettings.visibility)),
                _ => string.Concat(item.RepoSettings.visibility[0].ToString().ToUpper(), item.RepoSettings.visibility.AsSpan(1))
            };
            <div class="row rowStyle">
                <div class="col-md-5">
                    <div>
                        <a id="@item.Repo"></a>
                        <a href="https://github.com/samsmithnz/@item.Repo" target="_blank" class="projectHeader">@item.Repo</a> <span class="publicPrivateLabel">&nbsp;&nbsp;@visibility&nbsp;&nbsp;</span><br>
                        <span class="descriptionText">@item.RepoSettings.description</span><br>
                    </div>
                    <div>
                        @if (item.TotalRecommendationCount >= 0)
                        {
                            @if (item.RepoSettingsRecommendations.Count == 0 &&
                           item.BranchPolicies != null && item.BranchPoliciesRecommendations.Count == 0 &&
                           item.Actions.Count > 0 && item.ActionRecommendations.Count == 0 &&
                           item.Dependabot.Count > 0 && item.DependabotRecommendations.Count == 0 &&
                           item.GitVersion.Count > 0 && item.GitVersionRecommendations.Count == 0)
                            {
                                <i class="bi bi-heart-fill greenHeart" data-toggle="tooltip" data-placement="bottom" title="OK"></i> <span>0</span>
                            }
                            else
                            {
                                string recommendation = "Incomplete" + Environment.NewLine + Environment.NewLine;
                                foreach (string itemRec in item.RepoSettingsRecommendations)
                                {
                                    recommendation += " - " + itemRec + Environment.NewLine + Environment.NewLine;
                                }
                                foreach (string itemRec in item.BranchPoliciesRecommendations)
                                {
                                    recommendation += " - " + itemRec + Environment.NewLine + Environment.NewLine;
                                }
                                foreach (string itemRec in item.ActionRecommendations)
                                {
                                    recommendation += " - " + itemRec + Environment.NewLine + Environment.NewLine;
                                }
                                foreach (string itemRec in item.DependabotRecommendations)
                                {
                                    recommendation += " - " + itemRec + Environment.NewLine + Environment.NewLine;
                                }
                                foreach (string itemRec in item.GitVersionRecommendations)
                                {
                                    recommendation += " - " + itemRec + Environment.NewLine + Environment.NewLine;
                                }
                                <i class="bi bi-heart-pulse redHeart" data-toggle="tooltip" data-placement="bottom" title="@recommendation"></i> <span style="font-size: 14px;">@item.TotalRecommendationCount</span>
                            }
                        }
                        &nbsp;&nbsp;
                        <span class="iconify" data-icon="octicon:git-pull-request-16"></span> <a href="https://github.com/@item.Owner/@item.Repo/pulls" target="_blank" title="View all PRs" style="font-size: 14px;">@item.PullRequests.Count</a>

                        @if (item.Release != null || item.CoverallsCodeCoverage != null)
                        {
                            <br />
                            @if (item.Release != null)
                            {
                                <a href="@item.Release.html_url" target="_blank"><img src="https://img.shields.io/static/v1?label=Latest%20release&logo=github&message=@item.Release.name%20@(item.Release.ToTimingString())&color=blue" alt="Release badge"></a>
                            }
                            @if (item.CoverallsCodeCoverage != null)
                            {
                                string codeCoverageColor = "yellow";
                                if (item.CoverallsCodeCoverage.covered_percent < 50)
                                {
                                    codeCoverageColor = "red";
                                }
                                else if (item.CoverallsCodeCoverage.covered_percent >= 80)
                                {
                                    codeCoverageColor = "brightgreen";
                                }
                                <a href="https://coveralls.io/github/@(item.OwnerRepo)/@(item.Repo)" target="_blank"><img src="https://img.shields.io/static/v1?label=Code%20coverage&logo=coveralls&message=@item.CoverallsCodeCoverage.covered_percent.ToString("0")%&color=@codeCoverageColor" alt="Coveralls code coverage badge"></a>
                            }
                            @if (item.SonarCloud != null)
                            {
                                if (item.SonarCloud.CodeSmellsBadgeImage != null)
                                {
                                    <a href="@item.SonarCloud.CodeSmellsLink" target="_blank">@Html.Raw(item.SonarCloud.CodeSmellsBadgeImage)</a>
                                }
                                if (item.SonarCloud.BugsBadgeImage != null)
                                {
                                    <a href="@item.SonarCloud.BugsLink" target="_blank">@Html.Raw(item.SonarCloud.BugsBadgeImage)</a>
                                }
                            }
                        }
                        <br>
                        @if (@item.LastUpdated > DateTime.Now.AddDays(-7))
                        {
                            <span class="lastUpdatedText">Last updated: @item.LastUpdated.ToString("dd-MMM-yyyy HH:mmtt")</span>
                        }
                        else
                        {
                            <span class="lastUpdatedText">Last updated: </span>

                            <span class="lastUpdatedRedText">@item.LastUpdated.ToString("dd-MMM-yyyy HH:mmtt")</span>
                        }
                        @if (Model.IsContributor)
                        {
                            <a href="@Url.Action("UpdateRow", "Home", new { user = item.User, owner = item.Owner, repo = item.Repo, isContributor = Model.IsContributor })" class="lastUpdatedText">Update metrics</a>
                        }
                    </div>
                </div>
                <div class="col-md-2">
                    @if (item.RepoLanguages.Count > 0)
                    {
                        <div style="font-size:14px;">
                            <strong>Languages detected:</strong><br />
                            @foreach (RepoLanguage language in item.RepoLanguages)
                            {
                                if (language.Percent > 0.001M)
                                {
                                    <span class="box" style="background-color: @language.Color;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                    <span>@language.Name: @language.Percent.ToString("0.0")%</span>
                                    <br />
                                }
                            }
                        </div>
                    }
                    @*<canvas id="doughnut-chart-@(item.Repo)" width="200" height="200"></canvas>
                <script>
                @{
                string[] names = new string[item.RepoLanguages.Count];
                int[] totals = new int[item.RepoLanguages.Count];
                for (int i = 0; i < item.RepoLanguages.Count; i++)
                {
                names[i] = item.RepoLanguages[i].Name;
                totals[i] = (int)(item.RepoLanguages[i].Percent * 100);
                }
                }
                var labels = @Html.Raw(JsonSerializer.Serialize(names));
                var backgroundColor = [];
                var data = @Html.Raw(JsonSerializer.Serialize(totals));

                new Chart(document.getElementById("doughnut-chart-@(item.Repo)"), {
                type: 'doughnut',
                data: {
                labels: labels,
                datasets: [
                {
                label: "Languages %",
                backgroundColor: ["#3e95cd", "#8e5ea2", "#3cba9f", "#e8c3b9", "#c45850"],
                data: data
                }
                ]
                },
                options: {
                title: {
                display: true,
                text: 'Languages detected:'
                }
                }
                });
                </script>*@
                </div>
                <div class="col-md-2">
                    <strong>.NET targets:</strong><br />
                    @if (item.DotNetFrameworks.Count == 0)
                    {
                        <span class="badge bg-secondary">None found</span>
                    }
                    else
                    {
                        foreach (Framework framework in item.DotNetFrameworks)
                        {
                            <span class="badge @framework.Color">@framework.Name</span>
                            <br />
                        }
                    }
                </div>
                <div class="col-md-3">
                    <strong>DORA metrics:</strong><br />
                    @if (item.DORASummary != null)
                    {
                        <img src="@item.DORASummary.DeploymentFrequencyBadgeWithMetricURL" alt="Deployment frequency badge" />
                        <br />
                        <img src="@item.DORASummary.LeadTimeForChangesBadgeWithMetricURL" alt="Lead time for changes badge" />
                        <br />
                        <img src="@item.DORASummary.MeanTimeToRestoreBadgeURL" alt="Mean time to restore badge" />
                        <br />
                        <img src="@item.DORASummary.ChangeFailureRateBadgeURL" alt="Change failure rate badge" />
                    }
                </div>
            </div>
        }
    </div>
    <div>
        @if (Model.IsContributor)
        {
            <a href="@Url.Action("UpdateAll", "Home", new { isContributor = Model.IsContributor })" class="lastUpdatedText">Update all. Warning- takes a ~minute</a>

            <br />
            <a href="@Url.Action("ApprovePRsForAllRepos", "Home", new { isContributor = Model.IsContributor })" class="lastUpdatedText">Approve all open PRs. Warning- takes a ~minute</a>
        }
    </div>
</div>
